= Особенности настройки кластера {wc}

С целью повышения отказоустойчивости и распределения нагрузки, администратор может объединить несколько экземпляров модуля {wc} в кластер.

[#conditions]
== Обязательные условия для работы кластера

* Каждый экземпляр {wc}а должен иметь уникальный адрес подключения.
* Балансировщик нагрузки должен передавать заголовок X-Forwarded-Proto.

[#preparation]
=== Подготовка узлов кластера

.Чтобы подготовить узлы кластера {wc}а к работе:
. xref:install-server.adoc#windows[Установите] серверное расширение {wc} на машине с Windows.
. xref:install-server.adoc#linux[Установите и настройте] модуль {wc} на первом компьютере кластера Linux.
. xref:install-server.adoc#linux[Установите и настройте] Web-клиент на последующих узлах кластера Linux.
. Настройте балансировщик нагрузки.
// . Найдите в конфигурационном файле {wc}а *УЗЛА 1* отпечаток используемого {wc}ом сертификата, он потребуется при настройке второго и последующих узлов кластера.

// [#find-cert]
// === Найдите отпечаток
//
// .Чтобы найти отпечаток:
// . Откройте конфигурационный файл `{webconfig}` на *УЗЛЕ 1*.
// . Перейдите к настройке menu:microsoft.identityModel[service > serviceCertificate > certificateReference].
// . Найдите номер сертификата в значении атрибута `findValue`.
// +
// // tag::webconfig[]
// .Отпечаток сертификата в конфигурационном файле web.config
// [source,json]
// ----
//   "microsoft.identityModel": {
//     "service": {
//       "serviceCertificate": {
//         "certificateReference": {
//           "x509FindType": "FindByThumbprint"
//           "findValue": "B4369FA8D1B0A1B502CB916509317E9C6077CC69" <.>
//         }
//       }
//     }
//   }
// ----
// <.> Отпечаток сертификата
// // end::webconfig[]

[#create-cert]
=== Сгенерируйте отпечаток

. Если {wc} использует HTTPS, создайте сертификат с помощью OpenSSL. Пример использования утилиты приведён в разделе администрирования модуля {mc}: "xref:engineer:ROOT:create-cert.adoc[]".
+
// . Откройте меню menu:Пуск[Выполнить].
// . Введите команду `mmc` и нажмите *ОК*.
// . Выберите меню menu:Файл[Добавить или удалить оснастку].
// . Выберите из списка оснастку "Сертификаты" и нажмите на кнопку *Добавить*.
// . В открывшемся окне установите переключатель на учетной записи компьютера. Не изменяя настроек, нажмите на кнопку *Далее*, затем на кнопку *Готово*.
// . Откройте раздел menu:Личное[Сертификаты].
// +
// .Консоль управления "Сертификаты". "Хранилище", "Личное"
// image::certificate-manager.png[Консоль управления "Сертификаты". "Хранилище", "Личное"]
// +
// . Найдите сертификат, который выдан {dv} и имеет полученный ранее <<find-cert,отпечаток>>.
// +
// NOTE: Проверить владельца можно по данным сертификата.
// +
// .Данные сертификата
// image::cert-thumbprint.png[Данные сертификата]
// +
// . Нажмите на кнопку *Копировать в файл* и экспортируйте сертификат в файл в формате `Файл обмена личной информацией - PKCS #12 (.pfx)`, следуя подсказкам мастера.
// +
// NOTE: Чтобы скопировать сертификат в файл в формате `Файл обмена личной информацией - PKCS #12 (.pfx)`, нужно выбрать *Экспортировать закрытый ключ*.
// +
// WARNING: Необходимо экспортировать приватный ключ.
+
. Установите и настройте {wc} на втором компьютере кластера (далее -- *УЗЕЛ 2*).
+
WARNING: Экземпляр {wc}а, установленный на втором и последующих узлах кластера, должен быть настроен на работу с теми же сервером и базой данных {dv}, что и УЗЕЛ 1.
+
. В конфигурационном файле `{webconfig}` на УЗЛЕ 1 укажите путь к полученному сертификату в элементе `"Https":` (`"Http":`, если используется незащищённое соединение). Фрагмент конфигурационного файла приведён ниже:
+
[source,json]
----
"Https": {
  "Url": "https://*:5005",
  "Certificate": {
    "Path": "/home/user/certificate.pfx", <.>
    "Password": "password" <.>
    }
  }
----
<.> Путь к сертификату
<.> Пароль от сертификата
+
. Сгенерируйте сертификат на втором узле.
. Откройте конфигурационный файл `{webconfig}` на УЗЛЕ 2 и укажите путь к полученному сертификату.
// +
// . Укажите путь к <<create-cert,файлу сертификата>> в конфигурационном файле на компьютер УЗЛА 2.
// +
// .Чтобы импортировать файл сертификата:
// .. Скопируйте полученный <<create-cert,файл сертификата>> в формате `.pfx` на компьютер УЗЛА 2.
// .. Откройте контекстное меню файла `.pfx` и выберите команду *Установить сертификат*.
// .. Установите переключатель расположения хранилища в значение _Локальный компьютер_ и нажмите *Далее*.
// .. Установите переключатель *Поместить все сертификаты в следующее хранилище*, выберите хранилище "Личное" и нажмите *Далее*.
// .. Нажмите *Готово*.
// +
// ****
// Сертификат будет добавлен в личное хранилище сертификатов.
// ****
+
// === Проверьте корректность добавления сертификата
//
// Проверить корректность добавления сертификата можно повторив на компьютере со вторым экземпляром {wc}а <<create-cert,выгрузку сертификата>> *_без экспорта_*. Если сертификат был добавлен корректно, в списке сертификатов в хранилище _Личное_ будет присутствовать сертификат с корректным <<find-cert,отпечатком>>.
. Повторите шаги инструкции для третьего и последующих узлов кластера {wc}а.

См. также *xref:dvweb-cluster.adoc[Настройка утилиты DVWebTool для работы в кластере]*.

// [#balancing]
// == Балансировка нагрузки
//
// Иногда при работе {wc}а может наблюдаться снижение производительности даже при условии соблюдения всех системных требований. Это может выражаться в виде периодического замедления в начале рабочего дня или после рассылки писем со ссылкой на {wc}, в таких случаях замедление обычно продолжается не более 1-2 минут. Время отклика страницы может увеличиваться до минуты.
//
// Причина такого поведения заключается в слишком долгой адаптации сервера {wc}а к повысившейся активности пользователей.
//
// Решением ситуации является установка минимального числа потоков, которое соответствовало бы операционному состоянию сервера {wc}а. Значение устанавливается в конфигурационном файле по адресу `/usr/lib/docsvision/webclient/DocsVision.WebClient.runtimeconfig.json`.
//
// Минимальное число потоков определяется в соответствии с числом активных пользователей (максимальному числу активных-сессий). Более точное значение можно определить, проанализировав показатели счетчика производительности в течение рабочего дня:
//
// . Установите средства https://learn.microsoft.com/ru-ru/dotnet/core/diagnostics/dotnet-counters[dotnet-counter] и https://learn.microsoft.com/ru-ru/dotnet/core/diagnostics/dotnet-stack[dotnet-stack] для Linux.
// . Запустите средство `dotnet-counter` и проанализируйте с его помощью количество потоков:
// +
// [source]
// ----
// ./dotnet-counters  collect --counters "System.Runtime[threadpool-thread-count]" -p XXXXX <.>
// ----
// <.> `-p XXXXX` замените на PID процесса ВК
// +
// . В результате в каталоге средства появится файл `counters.csv` со значением счетчика в разное время.
// . Среднее значение счетчика под нагрузкой можно использовать как минимальное число потоков.
// +
// Укажите его в конфигурационном файле `/usr/lib/docsvision/webclient/DocsVision.WebClient.runtimeconfig.json` в параметре `runtimeOptions.configProperties.System.Threading.ThreadPool.MinThreads`:
// +
// [source,json]
// ----
// {
//   "runtimeOptions": {
//     "tfm": "net6.0",
//     "frameworks": [
//       {
//         "name": "Microsoft.NETCore.App",
//         "version": "6.0.0"
//       },
//       {
//         "name": "Microsoft.AspNetCore.App",
//         "version": "6.0.0"
//       }
//     ],
//     "configProperties": {
//       "System.GC.Server": true,
//       "System.Reflection.Metadata.MetadataUpdater.IsSupported": false,
//       "System.Runtime.Serialization.EnableUnsafeBinaryFormatterSerialization": true,
//       "System.Threading.ThreadPool.MinThreads": 100 <.>
//     }
//   }
// }
// ----
// <.> `"System.Threading.ThreadPool.MinThreads"` -- минимальное количество потоков.
// +
// [WARNING]
// ====
// Обратите внимание! Конфигурационный файл будет перезаписан при установке обновления. Рекомендуется изменять настройку в случае, если наблюдаются замедления в работе {wc}а во время резкого увеличения числа активных пользователей (например, в начале рабочего дня или после рассылки писем со ссылкой на {wc}). Можно также превентивно планировать эту конфигурацию при нормальной работе, если ожидается большое число одновременных пользователей.
// ====
// +
// . Перезапустите {wcs-new}.
