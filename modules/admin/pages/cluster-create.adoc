= Особенности настройки кластера {wc}

С целью повышения отказоустойчивости и распределения нагрузки, администратор может объединить несколько экземпляров модуля {wc} в кластер.

[#conditions]
== Обязательные условия для работы кластера

. Каждый экземпляр {wc}а должен иметь уникальный адрес подключения.
. На узлах кластера должен использоваться один сертификат шифрования.
. Балансировщик нагрузки должен передавать заголовок _X-Forwarded-Proto_.

[#preparation]
=== Подготовка узлов кластера

.Чтобы подготовить узлы кластера {wc}а к работе:
. xref:install-server.adoc[Установите серверное расширение {wc}] на сервер {dv}.
. xref:install-client.adoc[Установите] и xref:initial-configuration.adoc[настройте] модуль {wc} на первом компьютере кластера (далее -- *УЗЕЛ 1*).
. Найдите в конфигурационном файле {wc}а УЗЛА 1 отпечаток используемого {wc}ом сертификата, он потребуется при настройке второго и последующих узлов кластера.

[#find-cert]
=== Найдите отпечаток

.Чтобы найти отпечаток:
. Откройте конфигурационный файл`{webconfig}` на УЗЛЕ 1.
. Перейдите к настройке menu:configuration[microsoft.identityModel > service > serviceCertificate > certificateReference].
. Найдите номер сертификата в значении атрибута *_findValue_*.
+
// tag::webconfig[]
.Отпечаток сертификата в конфигурационном файле web.config
====
[source]
----
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
 <microsoft.identityModel>
  <service>
   <serviceCertificate>
    <certificateReference x509FindType="FindByThumbprint" findValue="B4369FA8D1B0A1B502CB916509317E9C6077CC69" /><.>
   </serviceCertificate>
  </service>
 </microsoft.identityModel>
</configuration>
----
<.> Отпечаток сертификата
====
// end::webconfig[]

[#export-cert]
=== Экспортируйте отпечаток

.Чтобы выгрузить сертификат с найденным <<find-cert,отпечатком>> в файл:

. Откройте меню menu:Пуск[Выполнить].
. Введите команду *mmc* и нажмите *ОК*.
. Выберите меню menu:Файл[Добавить или удалить оснастку].
. Выберите из списка оснастку "Сертификаты" и нажмите на кнопку *Добавить*.
. В открывшемся окне установите переключатель на учетной записи компьютера. Не изменяя настроек, нажмите на кнопку *Далее* и нажмите на кнопку *Готово*.
. Откройте раздел menu:Личное[Сертификаты].
+
.Консоль управления "Сертификаты". "Хранилище", "Личное"
image::certificate-manager.png[Консоль управления "Сертификаты". "Хранилище", "Личное"]
+
. Найдите сертификат, который выдан {dv} и имеет полученный на <<find-cert,отпечаток>>.
+
NOTE: Проверить владельца можно по данным сертификата.
+
.Данные сертификата
image::cert-thumbprint.png[Данные сертификата]
+
. Нажмите на кнопку *Копировать в файл* и экспортируйте сертификат в файл в формате `Файл обмена личной информацией -- PKCS #12 (.PFX)`, следуя подсказкам мастера.
+
NOTE: Чтобы скопировать сертификат в файл в формате `Файл обмена личной информацией -- PKCS #12 (.PFX)`, нужно выбрать *Экспортировать закрытый ключ*.
+
WARNING: Необходимо экспортировать приватный ключ.

[#second]
=== Настройте второй узел кластера

. Установите и настройте {wc} на втором компьютере кластера (далее -- *УЗЕЛ 2*).
+
WARNING: Экземпляр {wc}а, установленный на втором и последующих узлах кластера, должен быть настроен на работу с теми же сервером и базой данных {dv}, что и УЗЕЛ 1.
+
. Измените значение сертификата в конфигурационном файле {wc}а на УЗЛЕ 2, указав полученный <<find-cert,отпечаток>>.
+
.Чтобы изменить значение отпечатка:
. Откройте конфигурационный файл `{webconfig}` на УЗЛЕ 2.
. Перейдите к элементу menu:configuration[microsoft.identityModel > service > serviceCertificate > certificateReference].
. Измените значение атрибута *_findValue_* на значение полученного <<find-cert,отпечатка>>.
. Сохраните изменения конфигурационного файла.
. Импортируйте полученный <<export-cert,файл сертификата>> на компьютер УЗЛА 2.
+
.Чтобы импортировать файл сертификата:
.. Скопируйте полученный <<export-cert,файл сертификата>> в формате `.PFX` на компьютер УЗЛА 2.
.. Откройте контекстное меню файла `.PFX` и выберите команду *Установить сертификат*.
.. Установите переключатель расположения хранилища в значение _Локальный компьютер_ и нажмите *Далее*.
.. Установите переключатель *Поместить все сертификаты в следующее хранилище*, выберите хранилище "Личное" и нажмите *Далее*.
.. Нажмите *Готово*.
+
****
Сертификат будет добавлен в личное хранилище сертификатов.
****

[#check]
=== Проверьте корректность добавления сертификата

Проверить корректность добавления сертификата можно повторив на компьютере со вторым экземпляром {wc}а <<export-cert,выгрузку сертификата>> *_без экспорта_*. Если сертификат был добавлен корректно, в списке сертификатов в хранилище _Личное_ будет присутствовать сертификат с корректным <<find-cert,отпечатком>>.
****
Повторите шаги инструкции для третьего и последующих узлов кластера {wc}а.

См. также *xref:dvweb-cluster.adoc[Настройка утилиты DVWebTool для работы в кластере]*.
****

[#balancing]
== Балансировка нагрузки

Иногда при работе {wc}а может наблюдаться снижение производительности даже при условии соблюдения всех системных требований. Это может выражаться в виде периодического замедления в начале рабочего дня или после рассылки писем со ссылкой на {wc}, в таких случаях замедление обычно продолжается не более 1-2 минут. Время отклика страницы может увеличиваться до минуты.

Причина такого поведения заключается в слишком долгой адаптации сервера {wc}а к повысившейся активности пользователей.

Решением ситуации является установка минимального числа потоков, которое соответствовало бы операционному состоянию сервера {wc}а. Значение устанавливается в переменной окружения `COMPlus_ThreadPool_ForceMinWorkerThreads` для пула {wc}а.

Минимальное число потоков определяется в соответствии с числом активных пользователей (максимальным числом активных-сессий). Более точное значение можно определить, проанализировав показатели xref:performance-counters.adoc[счетчика производительности] `ThreadPool Thread Count` в течение рабочего дня. Среднее значение счетчика под нагрузкой можно использовать как минимальное число потоков.

После того как вы задали или изменили переменную, необходимо перезапустить IIS.
