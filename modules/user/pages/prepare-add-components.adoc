:root-cert: корневой сертификат удостоверяющего центраfootnote:[Например, корневой сертификат КриптоПро]
:wt: dvsupservice

= Установка дополнительных компонентов

[#cryptoPro]
== Установка компонентов КриптоПро

Для формирования усиленной подписи с использованием сертификатов ЭП необходимо установить компоненты КриптоПро и сертификаты.

Формирование усиленной подписи возможно только на персональных компьютерах, соответствующих xref:ROOT:requirements-signature.adoc[требованиям].

include::ROOT:page$requirements-signature.adoc[tags=macOS]

.Установите расширение для браузера:
. В {wc}е нажмите image:buttons/person-grey.png[Меню] (может содержать фото) *> Профиль*. Будет открыто диалоговое окно xref:interface-user-profile.adoc[профиля пользователя].
. Перейдите в раздел _Установки_.
. Перейдите по ссылке _Установить КриптоПро ЭЦП Browser plug-in_. Будет загружен файл `cadesplugin.exe`.
. Закройте веб-браузер и запустите загруженный файл `cadesplugin.exe`. Будет предложено установить _КриптоПро ЭЦП Browser plug-in_.
. Согласитесь с установкой и дождитесь её завершения.
. Установите расширение CryptoPro Extension for CAdES Browser Plug-in со https://chrome.google.com/webstore/detail/cryptopro-extension-for-c/iifchhfnnmpdbibifmljnfjhpififfog[страницы расширения].

Выполните указания в зависимости от типа сертификата:

.Если используется неквалифицированный сертификат
. Установите неквалифицированный сертификат пользователя в хранилище _Личное_ на уровне _Текущий пользователь_.

.Если используется квалифицированный сертификат КриптоПро
. Установите на компьютер https://www.cryptopro.ru/products/csp/downloads[СКЗИ КриптоПро CSP] (обратитесь к системному администратору).
. Установите квалифицированный сертификат пользователя в хранилище _Личное_ на уровне _Текущий пользователь_.
. Установите
ifdef::root-cert[{root-cert}]
в хранилище _Доверенные корневые центры сертификации_ на уровне _Локальный компьютер_.

[#dvWebTool]
== Установка и запуск программы DVWebTool

// tag::webtool[]
Программа _DVWebTool_ необходима для выполнения сканирования документов и открытия файлов в офисном редакторе в ОС {ms} Windows.
// Для работы функции к компьютеру пользователя должен быть подключен сканер.

WARNING: Программа _DVWebTool_ работает только в ОС {ms} Windows. Для работы требуется установить {net-r}.

// .Текущая версия программы поддерживает выполнение следующих операций:
// * Автоматическая консолидация версий согласуемых документов. +
// Для работы функции на компьютере пользователя должен быть установлен Microsoft Office.
// * Сканирование документов. +
// Для работы функции к компьютеру пользователя должен быть подключен сканер.

.Чтобы установить "DVWebTool":
. [[install-dvweb]]Для установки _DVWebTool_ на сервер Linux необходимо создать образ утилиты. Для этого откройте _{pu}_ на Windows.
. На главной странице Панели управления нажмите кнопку *Собрать DVWebTool*.
. В появившемся окне проверьте указанный порт (по умолчанию `5413`) и адрес сервера {wc}а. Нажмите *ОК*.
+
.Успешное завершение сборки
image::admin:dvweb-final-window.png[Успешное завершение сборки]
+
После завершения сборки появится окно об успешном завершении операции. При нажатии на кнопку *ОК* будет открыт каталог в файловой системе с собранными файлами DVWebTool.
+
. Перейдите в каталог `C:\Program Files (x86)\Docsvision\WebClient\Site\Content\Tools`.
. Скопируйте каталог _DVWebTool_ на сервер Linux по пути `/lib/docsvision/webclient/Content/Tools` (если каталог отсутствует, создайте его самостоятельно).
. Убедитесь, что в конфигурационном файле `{webconfig}`, в параметре `"DVWebToolInstallerUri":` указан адрес каталога: `Content\\Tools\\DVWebTool\\DocsVision.DVWebTool.application`.
. Перезапустите службу *{wcs-new}*.
. _DVWebTool_ будет установлена при первом открытии файла из карточки в ОС Windows. Программу также можно установить вручную из menu:Профиля пользователя[Установки > Установить DVWebTool].
+
После завершения установки программа _DVWebTool_ будет запущена автоматически, а в области уведомлений Windows появится значок программы (image:user:buttons/dv-web-ico.png[Две стрелочки в зелёном круге]).
+
Программа устанавливается только для текущего пользователя. Если на компьютере работает несколько пользователей (несколько профилей Windows), программу нужно установить каждому пользователю.
// +
// WARNING: Для корректной работы с программой _DVWebTool_ из браузера Internet Explorer, веб-сайты `\http://localhost` и `\https://localhost` должны быть перенесены из зоны _Местная интрасеть_ в зону _Доверенные узлы_.
//
// .Настройки безопасности зоны "Надежные сайты"
// image::install-dv-web-intranet.png[Настройки безопасности зоны "Надежные сайты"]
. [[launch-dvweb]]Программа _DVWebTool_ автоматически запускается при входе пользователя в ОС. Программу можно запустить вручную из меню menu:Пуск[Программы > {dv} > {dv} Web tool].
+
[NOTE]
====
include::ROOT:partial$excerpts.adoc[tags=dv-web-launch]
====
// end::webtool[]
+
. [[about-dvweb]]Для получения информации о программе, выберите пункт _About..._ в контекстном меню программы. Будет открыто окно _About_.
// +
// .Информация о программе DVWebTool
// image::dv-web-about.png[Информация о программе DVWebTool]
+
.Окно _About_ содержит:
* Название и версию программы.
* Список установленных расширений.
// В стандартной реализации: _Автоконсолидация_ и _Scan_.
+
. [[log-dvweb]]Для просмотра журнала работы программы, выберите пункт _View log_ в контекстном меню программы. +
Журнал будет открыт в стандартном текстовом редакторе.
+
. [[update-dvweb]]После установки новой версии {wc}а программу _DVWebTool_ потребуется заново собрать по инструкции выше.

[#dvSupService]
== Установка и запуск службы DVSupService

// tag::dvsup[]
Служба _DVSupService_ необходима для открытия файлов в офисном редакторе в ОС Linux.

WARNING: Служба _DVSupService_ работает только в ОС Linux. Для работы требуется установить {net-r}.

.Чтобы установить "DVSupService":
. [[install-dvsup]]Выполните следующую команду:
+
[tabs]
====
Astra Linux::
+
[subs=attributes]
 $ sudo apt install docsvision-{wt}

РЕД ОС::
+
[subs=attributes]
 $ sudo dnf install docsvision-{wt}
====
+
Служба будет установлена в каталог `/lib/docsvision/dvsupservice` от имени суперпользователя. Если на компьютере работает несколько пользователей, службу нужно установить один раз.
+
В конфигурационном файле службы по адресу `/usr/lib/docsvision/dvsupservice/appsettings.json` можно указать настройку `WebClientAddress` (по умолчанию null). Если для этой настройки указать адрес сервера (например `\http://docsvision.server.com:5004`), служба будет принимать запросы на открытие только с указанного адреса. При необходимости можно указать несколько адресов.
+
. [[launch-dvsup]]Запустите службу следующей командой:
+
[subs=attributes]
 $ sudo systemctl start {wt}
+
.Диалог сохранения в Р7-Офис
image::user:r7-notice.png[Диалог сохранения в Р7-Офис]
+
WARNING: При работе _DVSupService_ с Р7-Офис может появляться диалог сохранения. В таком случае необходимо, не изменяя директорию, нажать menu:Сохранить[Да].
+
. Посмотреть журнал работы можно по адресу `/var/log/docsvision/dvsupservice/$ДД-ММ-ГГГГ_DvSupService.log`. +
Путь по умолчанию может быть изменён в конфигурационном файле службы:
+
[source,json]
----
"fileName": "/var/log/docsvision/dvsupservice/${shortdate}_DvSupService.log"
----
+
. [[about-dvsup]]Чтобы просмотреть информацию о службе, выполните команду:
+
[tabs]
====
Astra Linux::
+
[subs=attributes]
 $ apt list docsvision-{wt}

РЕД ОС::
+
[subs=attributes]
 $ dnf list docsvision-{wt}
====
+
. [[update-dvsup]]Обновить службу можно, выполнив следующие команды:
+
[tabs]
====
Astra Linux::
+
[source,subs=attributes]
----
sudo apt-get update
sudo apt-get install docsvision-{wt}
----

РЕД ОС::
+
[subs=attributes]
 $ sudo dnf update docsvision-{wt}
====
+
. Удалить службу можно с помощью следующей команды:
+
[tabs]
====
Astra Linux::
+
[subs=attributes]
 $ sudo apt-get purge --autoremove docsvision-{wt}

РЕД ОС::
+
[subs=attributes]
 $ sudo dnf remove package docsvision-{wt}
====

.Запуск DVSupService
****
По умолчанию служба _DVSupService_ запускается от имени пользователя ROOT.

. Чтобы запустить службу от имени другого пользователя, необходимо выполнить следующую команду:
+
 sudo systemctl edit dvsupservice
+
. Записать следующее содержимое в появившемся окне:
+
 [Service]
 User=user
 Group=user
+
В примере выше `user` -- пользователь, от имени которого необходимо запускать _DVSupService_.
****
// end::dvsup[]
